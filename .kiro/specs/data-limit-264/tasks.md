# 实现计划: 数据限制功能（264条）

## 概述

实现固定容量的数据管理机制，确保每个采样规则只保留最新的264条符合规则的区块数据。核心改动集中在 App.tsx 的 WebSocket 消息处理逻辑中。

## 任务

- [x] 1. 修改 WebSocket 消息处理逻辑，添加容量限制
  - 在 App.tsx 的 `ws.onmessage` 回调中添加数据容量检查
  - 当添加新区块后，如果数据量超过264条，删除最旧的数据
  - 确保使用 `activeRuleRef.current` 获取最新规则
  - _需求: 1.1, 1.2, 2.3_

- [ ]* 1.1 编写属性测试：容量不变量
  - **属性 1: 容量不变量**
  - **验证: 需求 1.1**

- [ ]* 1.2 编写属性测试：降序不变量
  - **属性 2: 降序不变量**
  - **验证: 需求 1.4**

- [x] 2. 优化数据添加逻辑，确保正确的插入位置和排序
  - 确保新区块添加到数组开头（索引0）
  - 使用 Map 去重，避免重复区块
  - 确保最终数组按 height 降序排列
  - _需求: 1.3, 1.4_

- [ ]* 2.1 编写属性测试：插入位置属性
  - **属性 5: 插入位置属性**
  - **验证: 需求 1.3**

- [x] 3. 确保规则过滤逻辑正确应用
  - 验证 `checkAlignment` 函数在 WebSocket 中正确调用
  - 确保不符合规则的区块被跳过
  - 添加开发模式日志输出
  - _需求: 2.1, 2.2, 2.4_

- [ ]* 3.1 编写属性测试：规则过滤属性
  - **属性 3: 规则过滤属性**
  - **验证: 需求 2.1, 2.2, 2.4**

- [ ]* 3.2 编写属性测试：容量限制和淘汰属性
  - **属性 4: 容量限制和淘汰属性**
  - **验证: 需求 1.2, 2.3**

- [x] 4. 添加单元测试覆盖边界情况
  - [x] 4.1 测试恰好264条数据时的行为
    - 验证添加第265条数据时，最旧的被删除
    - _需求: 1.2_
  
  - [ ]* 4.2 测试空数据时添加第一条数据
    - 验证 allBlocks 为空时添加数据的正确性
    - _需求: 1.3_
  
  - [ ]* 4.3 测试重复区块的去重逻辑
    - 验证添加相同 height 的区块时被跳过
    - _需求: 1.4_

- [x] 5. 检查点 - 确保所有测试通过
  - 确保所有测试通过，如有问题请询问用户

## 注意事项

- 标记 `*` 的任务为可选任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 属性测试使用 fast-check 库，每个测试至少运行100次迭代
- 单元测试关注具体的边界情况和错误处理
