# 实现计划：修复珠盘路显示问题

## 概述

本实现计划将修复 `calculateBeadGrid` 函数的参数使用问题，优化珠盘路数据填充逻辑，实现按列滑动机制，并确保数据一致性。

## 任务

- [x] 1. 修复 calculateBeadGrid 函数
  - [x] 1.1 添加参数验证逻辑
    - 验证 `rows`、`interval`、`startBlock` 参数的有效性
    - 对无效参数使用默认值
    - _需求: 1.1, 1.2, 1.3, 1.4_
  
  - [x] 1.2 实现数据过滤逻辑
    - 根据 `interval` 和 `startBlock` 过滤区块数据
    - 处理步长为 1 的特殊情况（不过滤）
    - 处理步长大于 1 的情况（按规则过滤）
    - _需求: 1.1, 1.2, 1.3, 1.4_
  
  - [x] 1.3 实现容量限制逻辑
    - 当数据超过 264 条时，只保留最新的 264 条
    - 使用滑动窗口机制
    - _需求: 2.3_
  
  - [x] 1.4 实现网格填充逻辑
    - 按照从左到右、从上到下的顺序填充
    - 使用公式：col = floor(index / rows), row = index % rows
    - 填充空单元格（type 为 null）
    - _需求: 2.1, 2.2, 2.4_
  
  - [ ]* 1.5 编写单元测试
    - 测试空数据数组
    - 测试步长为 1 的情况
    - 测试边界数据量（264 条和 265 条）
    - 测试无效参数的默认值处理
    - _需求: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4_

- [ ] 2. 编写属性测试
  - [ ]* 2.1 属性测试：数据过滤正确性
    - **属性 1：数据过滤正确性**
    - **验证：需求 1.1, 1.2, 1.4**
    - 生成随机区块数据、步长和起始偏移
    - 验证网格中所有区块都符合规则
    - 配置：至少 100 次迭代
  
  - [ ]* 2.2 属性测试：填充顺序正确性
    - **属性 2：填充顺序正确性**
    - **验证：需求 2.1, 2.2**
    - 生成随机区块数据
    - 验证每个非空单元格的位置符合公式
    - 配置：至少 100 次迭代
  
  - [ ]* 2.3 属性测试：容量限制正确性
    - **属性 3：容量限制正确性**
    - **验证：需求 2.3**
    - 生成超过 264 条的随机数据
    - 验证只包含最新的 264 条数据
    - 配置：至少 100 次迭代
  
  - [ ]* 2.4 属性测试：空单元格填充正确性
    - **属性 4：空单元格填充正确性**
    - **验证：需求 2.4**
    - 生成少于 264 条的随机数据
    - 验证剩余位置都是空单元格
    - 配置：至少 100 次迭代
  
  - [ ]* 2.5 属性测试：按列滑动机制正确性
    - **属性 5：按列滑动机制正确性**
    - **验证：需求 2.5, 2.6**
    - 生成 264-270 条随机数据
    - 验证按列滑动机制的触发和行为
    - 配置：至少 100 次迭代
  
  - [ ]* 2.6 属性测试：规则切换后数据正确性
    - **属性 6：规则切换后数据正确性**
    - **验证：需求 3.2, 3.3, 3.4**
    - 生成随机数据和两个随机规则
    - 验证规则切换后数据的正确性
    - 配置：至少 100 次迭代

- [x] 3. 验证集成
  - [x] 3.1 验证 BeadRoad 组件集成
    - 确认 BeadRoad 组件正确传递参数
    - 确认网格渲染正确
    - 确认自动滚动功能正常
    - _需求: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_
  
  - [x] 3.2 验证规则切换功能
    - 测试切换不同步长的规则
    - 测试切换不同起始偏移的规则
    - 确认网格正确更新
    - _需求: 3.1, 3.2, 3.3, 3.4_
  
  - [x] 3.3 验证 WebSocket 数据流
    - 确认 App.tsx 正确过滤数据
    - 确认珠盘路显示与过滤数据一致
    - 确认新区块到达时网格正确更新
    - _需求: 4.1, 4.2, 4.3, 4.4_

- [x] 4. 代码质量检查
  - [x] 4.1 运行 TypeScript 编译器
    - 确认没有未使用参数的警告
    - 确认没有类型错误
    - _需求: 5.1, 5.2_
  
  - [x] 4.2 运行所有测试
    - 确认所有单元测试通过
    - 确认所有属性测试通过
    - 确认测试覆盖率达标
  
  - [x] 4.3 性能测试
    - 测试大数据量（1000+ 区块）的性能
    - 确认没有性能退化
    - 确认内存使用合理

- [x] 5. 最终检查点
  - 确保所有测试通过
  - 确保没有 TypeScript 警告
  - 确保珠盘路显示正确
  - 询问用户是否有问题

## 注意事项

- 任务标记 `*` 的为可选任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，便于追溯
- 属性测试使用 fast-check 库，每个测试至少运行 100 次迭代
- 单元测试和属性测试是互补的，两者都需要实现以确保全面覆盖
