# 数据加载问题排查指南

## 🔍 问题排查步骤

### 1. 检查浏览器控制台

打开浏览器开发者工具（F12），查看 Console 面板，寻找以下日志：

#### 正常情况应该看到：
```
[配置] 🔄 开始从 Redis 加载配置...
[配置] ✅ 主题颜色已加载
[配置] ✅ 采样规则已加载: X 条
[配置] ✅ 激活规则已加载: X
[配置] ✅ 关注模式已加载: X 个
[配置] ✅ 从 Redis 加载配置成功
[连接] 正在连接到 Redis 后端 WebSocket...
[连接] ✅ WebSocket 连接成功
[架构] TRON → Redis → WebSocket → 前端 (延迟 ~70ms)
[API] 🚀 正在从后端加载过滤后的数据...
[API] 规则: XXX, 步长: X, 偏移: X, 需要: 264 条
[API] ✅ 后端加载完成: XXX 条
[缓存] 💾 已缓存规则: X-X
```

#### 可能的错误信息：

**错误1：后端服务未启动**
```
[API] 加载历史数据失败: Failed to fetch
[API] ⚠️ 请确保后端服务正在运行 (npm run dev)
```
**解决方案**：启动后端服务
```bash
cd backend
npm run dev
```

**错误2：WebSocket 连接失败**
```
[连接] ❌ WebSocket 连接失败，5秒后重连...
```
**解决方案**：检查后端 WebSocket 服务是否正常运行

**错误3：缓存数据为空**
```
[缓存] ✅ 使用缓存数据: 0 条
```
**解决方案**：这是一个 bug，缓存不应该保存空数据

---

### 2. 检查 Network 面板

打开浏览器开发者工具的 Network 面板，查看网络请求：

#### 应该看到的请求：

1. **配置加载请求**：
   - `GET http://localhost:3001/api/config/theme`
   - `GET http://localhost:3001/api/config/rules`
   - `GET http://localhost:3001/api/config/active-rule`
   - `GET http://localhost:3001/api/config/followed-patterns`

2. **数据加载请求**（首次加载或缓存未命中时）：
   - `GET http://localhost:3001/api/blocks?limit=264&ruleValue=1&startBlock=0`
   - 状态码应该是 200
   - 响应应该包含 `success: true` 和 `data` 数组

3. **WebSocket 连接**：
   - `WS ws://localhost:8080`
   - 状态应该是 101 Switching Protocols

#### 可能的问题：

**问题1：请求返回 404**
- 后端路由配置错误
- 检查 `backend/src/api.ts` 中的路由定义

**问题2：请求返回 500**
- 后端代码错误
- 检查后端控制台的错误日志

**问题3：请求被 CORS 阻止**
- 后端 CORS 配置问题
- 检查 `backend/src/api.ts` 中的 `app.use(cors())` 是否正确

---

### 3. 检查后端控制台

查看后端控制台（运行 `npm run dev` 的终端），应该看到：

#### 正常日志：
```
[API] 🚀 REST API 启动在端口 3001
[WebSocket] 🚀 WebSocket 服务启动在端口 8080
[API] 📥 规则过滤请求: 步长 1, 偏移 0, 需要 264 条过滤后数据
[API] 📊 预估加载: 396 条，实际加载: 396 条
[API] 📦 加载原始数据: 396 条
[API] 🔍 过滤后数据: 396 条 (步长 1)
[API] ✅ 返回数据: 264 条 (请求: 264 条)
[API] ⏱️ 性能统计:
  - Redis 加载: XXms
  - 内存过滤: XXms
  - 总耗时: XXms
[API] 💾 数据加载优化: 减少 XX% 的数据加载
```

#### 可能的错误：

**错误1：Redis 连接失败**
```
Error: Redis connection failed
```
**解决方案**：启动 Redis 服务

**错误2：数据为空**
```
[API] 📦 加载原始数据: 0 条
```
**解决方案**：Redis 中没有数据，需要等待 TRON 监听器写入数据

---

### 4. 常见问题和解决方案

#### 问题1：页面显示空白，没有数据

**可能原因**：
1. 后端服务未启动
2. Redis 中没有数据
3. WebSocket 连接失败
4. 前端缓存逻辑错误

**排查步骤**：
1. 检查后端服务是否运行：`http://localhost:3001/health`
2. 检查 Redis 是否有数据：
   ```bash
   redis-cli
   LLEN tron:blocks
   ```
3. 检查浏览器控制台的错误日志
4. 检查 Network 面板的请求状态

**临时解决方案**：
- 清除浏览器缓存和 localStorage
- 重启前端和后端服务
- 重启 Redis 服务

---

#### 问题2：切换规则后数据不更新

**可能原因**：
1. 缓存逻辑错误
2. `loadHistoryBlocks` 函数未被调用
3. 后端返回的数据为空

**排查步骤**：
1. 打开浏览器控制台，切换规则时应该看到：
   ```
   [规则变化] 切换到规则: XXX
   [缓存] ✅ 使用缓存数据: XXX 条
   ```
   或
   ```
   [规则变化] 切换到规则: XXX
   [API] 🚀 正在从后端加载过滤后的数据...
   ```

2. 检查 Network 面板，看是否有新的 `/api/blocks` 请求

3. 在浏览器控制台执行：
   ```javascript
   window.debugApp.printDebugInfo()
   ```
   查看当前状态

**临时解决方案**：
- 刷新页面（F5）
- 清除缓存：在控制台执行 `localStorage.clear()`

---

#### 问题3：数据加载很慢

**可能原因**：
1. 后端动态加载逻辑未生效，仍在加载 30,000 条数据
2. Redis 性能问题
3. 网络延迟

**排查步骤**：
1. 检查后端控制台的性能日志：
   ```
   [API] ⏱️ 性能统计:
     - Redis 加载: XXms
     - 内存过滤: XXms
     - 总耗时: XXms
   ```

2. 检查后端是否使用了动态加载：
   ```
   [API] 📊 预估加载: XXX 条，实际加载: XXX 条
   ```
   如果实际加载是 30,000 条，说明动态加载未生效

3. 检查 `backend/src/api.ts` 中的代码是否正确

---

#### 问题4：缓存未命中，每次都重新加载

**可能原因**：
1. `blocksCacheRef` 未正确同步
2. 缓存 key 计算错误
3. 缓存被意外清除

**排查步骤**：
1. 在浏览器控制台执行：
   ```javascript
   window.debugApp.blocksCache
   ```
   查看缓存内容

2. 切换规则后，再次执行上述命令，看缓存是否增加

3. 检查控制台日志，看是否有缓存清理的日志：
   ```
   [缓存] 🗑️ 删除最旧的缓存: XXX
   ```

---

### 5. 调试工具

#### 在浏览器控制台执行以下命令进行调试：

```javascript
// 1. 查看当前状态
window.debugApp.printDebugInfo()

// 2. 查看缓存内容
console.log('缓存大小:', window.debugApp.blocksCache?.size)
console.log('缓存内容:', window.debugApp.blocksCache)

// 3. 查看当前规则
console.log('当前规则:', window.debugApp.activeRule)

// 4. 查看所有区块数据
console.log('区块数量:', window.debugApp.allBlocks?.length)
console.log('区块数据:', window.debugApp.allBlocks)

// 5. 手动触发数据加载（用于测试）
// 注意：这个功能需要在代码中暴露 loadHistoryBlocks 函数
```

---

### 6. 修复建议

根据你遇到的具体问题，我可以提供针对性的修复方案。请告诉我：

1. **浏览器控制台显示什么错误？**
2. **Network 面板显示什么请求状态？**
3. **后端控制台显示什么日志？**
4. **具体的问题表现是什么？**
   - 完全没有数据？
   - 数据加载很慢？
   - 切换规则后数据不更新？
   - 其他问题？

---

## 🔧 快速修复检查清单

- [ ] 后端服务是否运行？（`http://localhost:3001/health`）
- [ ] Redis 服务是否运行？（`redis-cli ping`）
- [ ] Redis 中是否有数据？（`redis-cli LLEN tron:blocks`）
- [ ] WebSocket 服务是否运行？（`ws://localhost:8080`）
- [ ] 浏览器控制台是否有错误？
- [ ] Network 面板的请求是否成功？
- [ ] 后端控制台是否有错误？

---

## 📝 已知问题和修复

### 修复1：loadHistoryBlocks 依赖项优化

**问题**：`loadHistoryBlocks` 的依赖项包含了 `requiredDataCount`，导致不必要的重新创建

**修复**：
```typescript
// 修改前
}, [activeRule, requiredDataCount]);

// 修改后
}, [activeRule]);  // ✅ 只依赖 activeRule，使用 ref 访问缓存
```

**状态**：✅ 已修复

---

请提供更多信息，我会帮你进一步排查问题！
