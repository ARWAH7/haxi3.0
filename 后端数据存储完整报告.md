# 后端数据存储完整报告

## 报告概述

本报告详细分析了后端（Node.js + Redis）保存的所有数据，包括 30000 条区块数据的存储位置、文件结构、数据量和管理机制。

**生成时间**：2024年  
**后端技术栈**：Node.js + Express + Redis + ioredis  
**数据存储方式**：Redis（主要）+ 内存存储（备用）

---

## 数据存储架构

### 存储层级

```
后端数据存储
├── Redis（主要存储）
│   ├── 区块数据（最多 30000 条）
│   ├── 配置数据
│   ├── AI 预测数据（最多 10000 条/组合）
│   └── 下注数据（最多 10000 条）
└── 内存存储（备用）
    ├── 区块数据（最多 30000 条）
    ├── 配置数据
    ├── AI 预测数据
    └── 下注数据
```

---

## 核心文件

### 1. `backend/src/redis.ts`
**作用**：Redis 数据存储和管理的核心文件

**主要功能**：
- Redis 连接管理
- 区块数据的保存和读取
- AI 预测数据的保存和读取
- 下注数据的保存和读取
- 内存存储备用方案

**代码行数**：约 800 行

---

### 2. `backend/src/api.ts`
**作用**：REST API 接口定义

**主要功能**：
- 提供 HTTP API 接口
- 处理前端请求
- 调用 redis.ts 中的函数
- 实现规则过滤和动态加载优化

**代码行数**：约 600 行

---

### 3. `backend/src/index.ts`
**作用**：后端服务入口文件

**主要功能**：
- 启动 Express 服务器
- 启动 WebSocket 服务器
- 启动 TRON 区块监听器

---

### 4. `backend/src/websocket.ts`
**作用**：WebSocket 服务器

**主要功能**：
- 实时推送新区块到前端
- 订阅 Redis Pub/Sub 频道

---

### 5. `backend/src/tron-listener.ts`
**作用**：TRON 区块链监听器

**主要功能**：
- 监听 TRON 区块链新区块
- 保存区块到 Redis
- 发布新区块事件

---

## 第一部分：区块数据（30000 条）

### 1.1 存储位置

**Redis 键名**：
```
tron:blocks                    # 有序集合（Sorted Set）
tron:block:{height}            # 哈希（Hash）- 单个区块详情
```

**内存存储**（备用）：
```typescript
memoryStorage.blocks           # Map<number, any>
memoryStorage.blockHeights     # number[]
```

---

### 1.2 数据结构

#### Redis 存储结构

**有序集合（Sorted Set）**：
```
键名：tron:blocks
成员：区块高度（例如: "79930214"）
分数：区块高度（用于排序）
```

**哈希（Hash）**：
```
键名：tron:block:{height}
字段：
  - height: 区块高度
  - hash: 区块哈希
  - timestamp: 时间戳
  - type: 单双类型（ODD/EVEN）
  - sizeType: 大小类型（BIG/SMALL）
  - data: JSON 字符串（完整区块数据）
```

#### 区块数据字段

```typescript
interface BlockData {
  height: number;        // 区块高度
  hash: string;          // 区块哈希（64 字符）
  resultValue: number;   // 结果值（0-9）
  type: BlockType;       // 单双类型（ODD/EVEN）
  sizeType: SizeType;    // 大小类型（BIG/SMALL）
  timestamp: number;     // Unix 时间戳
}
```

---

### 1.3 数据量分析

**最大容量**：30000 条区块

**单条数据大小**：
```
height: 8 字节（number）
hash: 64 字节（string）
resultValue: 8 字节（number）
type: 4 字节（string）
sizeType: 5 字节（string）
timestamp: 8 字节（number）
---
总计：约 97 字节（不含 JSON 序列化开销）
```

**Redis 存储开销**：
```
有序集合成员：8 字节（height）
有序集合分数：8 字节（score）
哈希键名：约 20 字节（"tron:block:79930214"）
哈希字段：约 150 字节（6 个字段 + 值）
---
总计：约 186 字节/条
```

**总数据量**：
```
30000 条 × 186 字节 = 5,580,000 字节 ≈ 5.32 MB
```

**实际 Redis 占用**（含开销）：
```
约 8-10 MB（Redis 内部开销 + 序列化开销）
```

---

### 1.4 数据管理机制

#### 自动清理机制

**触发条件**：区块数量 > 30000

**清理策略**：
```typescript
// 保持最新 30000 个区块
if (count > MAX_BLOCKS) {
  const toRemove = count - MAX_BLOCKS;
  
  // 1. 删除有序集合中最旧的区块
  await redis.zremrangebyrank(REDIS_KEYS.BLOCKS, 0, toRemove - 1);
  
  // 2. 删除对应的哈希键
  oldBlocks.forEach(height => {
    await redis.del(`tron:block:${height}`);
  });
}
```

**清理频率**：每次保存新区块时检查

**清理日志**：
```
[Redis] 🧹 清理 100 个旧区块
```

---

#### 过期时间设置

**区块详情过期时间**：7 天

```typescript
// 设置过期时间（7 天）
pipeline.expire(`tron:block:${block.height}`, 7 * 24 * 60 * 60);
```

**作用**：
- 防止 Redis 内存无限增长
- 自动清理长时间未访问的区块

---

### 1.5 数据加载优化

#### 动态加载机制

**优化前**：
```
固定加载 30000 条数据
↓
内存过滤
↓
返回 264 条
```

**优化后**：
```
动态计算需要加载的数据量
↓
加载 estimatedRawBlocks 条（最多 30000）
↓
内存过滤
↓
返回 264 条
```

**计算公式**：
```typescript
const safetyFactor = 1.5;
const estimatedRawBlocks = Math.ceil(limit * ruleValue * safetyFactor);
const MAX_RAW_BLOCKS = Math.min(estimatedRawBlocks, 30000);
```

**示例**：
```
规则步长 1：需要 264 条 → 加载 396 条（264 × 1 × 1.5）
规则步长 20：需要 264 条 → 加载 7920 条（264 × 20 × 1.5）
规则步长 100：需要 264 条 → 加载 30000 条（264 × 100 × 1.5 = 39600，超过上限）
```

**性能提升**：
```
步长 1：减少 99% 的数据加载（396 vs 30000）
步长 20：减少 74% 的数据加载（7920 vs 30000）
步长 100：无优化（30000 vs 30000）
```

---

### 1.6 区块数据总结

| 项目 | 值 |
|------|-----|
| **最大容量** | 30000 条 |
| **单条大小** | 约 186 字节 |
| **总数据量** | 约 5.32 MB |
| **实际占用** | 约 8-10 MB（含 Redis 开销）|
| **存储位置** | Redis（主要）+ 内存（备用）|
| **过期时间** | 7 天 |
| **清理策略** | 自动清理，保持最新 30000 条 |
| **加载优化** | 动态计算，减少 0-99% 的数据加载 |

---

## 第二部分：配置数据

### 2.1 主题颜色

**Redis 键名**：`tron:config:theme`

**数据结构**：
```json
{
  "odd": "#ef4444",
  "even": "#14b8a6",
  "big": "#f97316",
  "small": "#6366f1"
}
```

**数据量**：约 100 字节

---

### 2.2 采样规则

**Redis 键名**：`tron:config:rules`

**数据结构**：
```json
[
  {
    "id": "1",
    "label": "3秒",
    "value": 1,
    "startBlock": 0,
    "trendRows": 6,
    "beadRows": 6,
    "dragonThreshold": 3
  },
  ...
]
```

**数据量**：约 800 字节（8 个规则）

---

### 2.3 激活规则 ID

**Redis 键名**：`tron:config:active_rule`

**数据结构**：`"1"`（字符串）

**数据量**：约 10 字节

---

### 2.4 关注模式

**Redis 键名**：`tron:config:followed_patterns`

**数据结构**：
```json
[
  {
    "ruleId": "1",
    "type": "parity",
    "mode": "trend"
  },
  ...
]
```

**数据量**：约 0-2.5 KB（取决于用户）

---

### 2.5 配置数据总结

| 数据项 | Redis 键名 | 数据量 |
|--------|-----------|--------|
| 主题颜色 | `tron:config:theme` | 100 字节 |
| 采样规则 | `tron:config:rules` | 800 字节 |
| 激活规则 ID | `tron:config:active_rule` | 10 字节 |
| 关注模式 | `tron:config:followed_patterns` | 0-2.5 KB |
| **总计** | - | **约 3.4 KB** |

---

## 第三部分：AI 预测数据

### 3.1 AI 预测历史

**Redis 键名**：`tron:ai:predictions:{modelId}-{ruleId}`

**数据结构**：有序集合（Sorted Set）
```
成员：JSON 字符串（预测记录）
分数：时间戳（用于排序）
```

**单条预测数据**：
```json
{
  "id": "pred-123",
  "timestamp": 1234567890,
  "modelId": "model-1",
  "ruleId": "1",
  "targetHeight": 79930214,
  "shouldPredict": true,
  "nextParity": "ODD",
  "parityConfidence": 0.85,
  "nextSize": "BIG",
  "sizeConfidence": 0.75,
  "analysis": "检测到周期性模式...",
  "detectedCycle": "5-3-5",
  "riskLevel": "LOW",
  "entropyScore": 0.3,
  "resolved": true,
  "actualParity": "ODD",
  "actualSize": "BIG",
  "isParityCorrect": true,
  "isSizeCorrect": true
}
```

**数据量**：
- 单条预测：约 300 字节
- 最大容量：10000 条/组合
- 总数据量：10000 × 300 = **3 MB/组合**

**组合数量**：
- 模型数量：约 10 个
- 规则数量：约 8 个
- 理论最大组合：10 × 8 = 80 个
- 实际使用组合：约 10-20 个

**总数据量**：
- 理论最大：80 × 3 MB = **240 MB**
- 实际使用：20 × 3 MB = **60 MB**

---

### 3.2 AI 模型统计

**Redis 键名**：`tron:ai:model_stats`

**数据结构**：
```json
{
  "model-1": { "total": 100, "correct": 65 },
  "model-2": { "total": 150, "correct": 90 },
  ...
}
```

**数据量**：约 500 字节（10 个模型）

---

### 3.3 AI 数据总结

| 数据项 | Redis 键名 | 最大容量 | 数据量 |
|--------|-----------|---------|--------|
| 预测历史 | `tron:ai:predictions:*` | 10000 条/组合 | 0-60 MB |
| 模型统计 | `tron:ai:model_stats` | - | 500 字节 |
| **总计** | - | - | **约 60 MB** |

---

## 第四部分：下注数据

### 4.1 下注记录

**Redis 键名**：`tron:bets:records`

**数据结构**：有序集合（Sorted Set）
```
成员：JSON 字符串（下注记录）
分数：时间戳（用于排序）
```

**单条下注记录**：
```json
{
  "id": "bet-123",
  "timestamp": 1234567890,
  "blockHeight": 79930214,
  "betAmount": 100,
  "betType": "parity",
  "betChoice": "ODD",
  "result": "win",
  "payout": 196,
  "ruleId": "1"
}
```

**数据量**：
- 单条记录：约 150 字节
- 最大容量：10000 条
- 总数据量：10000 × 150 = **1.5 MB**

---

### 4.2 托管任务

**Redis 键名**：`tron:bets:tasks`

**数据结构**：JSON 数组

**数据量**：约 0-10 KB（取决于任务数量）

---

### 4.3 下注配置

**Redis 键名**：`tron:bets:config`

**数据结构**：JSON 对象

**数据量**：约 100 字节

---

### 4.4 账户余额

**Redis 键名**：`tron:bets:balance`

**数据结构**：字符串（数字）

**数据量**：约 10 字节

---

### 4.5 全局指标

**Redis 键名**：`tron:bets:global_metrics`

**数据结构**：JSON 对象

**数据量**：约 50 字节

---

### 4.6 下注数据总结

| 数据项 | Redis 键名 | 最大容量 | 数据量 |
|--------|-----------|---------|--------|
| 下注记录 | `tron:bets:records` | 10000 条 | 0-1.5 MB |
| 托管任务 | `tron:bets:tasks` | - | 0-10 KB |
| 下注配置 | `tron:bets:config` | - | 100 字节 |
| 账户余额 | `tron:bets:balance` | - | 10 字节 |
| 全局指标 | `tron:bets:global_metrics` | - | 50 字节 |
| **总计** | - | - | **约 1.5 MB** |

---

## 总结报告

### Redis 数据存储总览

| 数据类别 | Redis 键名前缀 | 最大容量 | 数据量 | 清理策略 |
|---------|---------------|---------|--------|---------|
| **区块数据** | `tron:blocks` | 30000 条 | 8-10 MB | 自动清理 |
| **配置数据** | `tron:config:*` | - | 3.4 KB | 手动清除 |
| **AI 数据** | `tron:ai:*` | 10000 条/组合 | 0-60 MB | 自动清理 |
| **下注数据** | `tron:bets:*` | 10000 条 | 0-1.5 MB | 自动清理 |
| **总计** | - | - | **约 70 MB** | - |

---

### 关键发现

#### 1. 区块数据是核心存储
- **30000 条区块数据**占用约 8-10 MB
- 使用有序集合（Sorted Set）+ 哈希（Hash）存储
- 自动清理机制，保持最新 30000 条
- 动态加载优化，减少 0-99% 的数据加载

#### 2. AI 数据占用最大
- **AI 预测历史**最多可达 60 MB
- 每个模型+规则组合最多保存 10000 条预测
- 实际使用约 10-20 个组合
- 自动清理机制，保持最新 10000 条/组合

#### 3. 下注数据适中
- **下注记录**最多 1.5 MB
- 最多保存 10000 条记录
- 自动清理机制

#### 4. 配置数据很小
- **配置数据**仅 3.4 KB
- 包含主题颜色、采样规则、激活规则、关注模式
- 手动清除

---

### 数据流向图

```
TRON 区块链
    ↓
tron-listener.ts（监听新区块）
    ↓
redis.ts（保存到 Redis）
    ├─ tron:blocks（有序集合）
    └─ tron:block:{height}（哈希）
    ↓
Redis Pub/Sub（发布新区块事件）
    ↓
websocket.ts（WebSocket 推送）
    ↓
前端（实时更新）
```

---

### 内存存储备用方案

**触发条件**：Redis 连接失败

**存储位置**：Node.js 进程内存

**数据结构**：
```typescript
const memoryStorage = {
  blocks: new Map<number, any>(),      // 区块详情
  blockHeights: [] as number[],        // 区块高度（按顺序）
  stats: { latestHeight: 0, lastUpdate: 0 },
  aiPredictions: new Map<string, any[]>(),
  aiModelStats: {} as Record<string, { total: number; correct: number }>,
  betRecords: [] as any[],
  betTasks: [] as any[],
  betConfig: null as any,
};
```

**优点**：
- ✅ 无需 Redis，降低部署复杂度
- ✅ 读写速度快
- ✅ 自动回退，无需手动切换

**缺点**：
- ❌ 重启后数据丢失
- ❌ 容量有限（受 Node.js 内存限制）
- ❌ 无法跨进程共享

---

### 优化建议

#### 建议 1：限制 AI 预测历史数量（高优先级）⭐⭐⭐⭐⭐

**目标**：将每个组合的最大容量从 10000 条减少到 1000 条

**收益**：
- 减少 Redis 占用：60 MB → 6 MB（节省 54 MB）
- 提高查询性能
- 减少内存占用

**实施难度**：低（10 分钟）

**修改位置**：`backend/src/redis.ts`
```typescript
// 修改前
if (count > 10000) {
  const toRemove = count - 10000;
  ...
}

// 修改后
if (count > 1000) {
  const toRemove = count - 1000;
  ...
}
```

---

#### 建议 2：限制下注记录数量（中优先级）⭐⭐⭐

**目标**：将最大容量从 10000 条减少到 500 条

**收益**：
- 减少 Redis 占用：1.5 MB → 75 KB（节省 1.425 MB）
- 提高查询性能

**实施难度**：低（10 分钟）

**修改位置**：`backend/src/redis.ts`
```typescript
// 修改前
if (count > 10000) {
  const toRemove = count - 10000;
  ...
}

// 修改后
if (count > 500) {
  const toRemove = count - 500;
  ...
}
```

---

#### 建议 3：添加 Redis 持久化配置（低优先级）⭐⭐

**目标**：配置 Redis RDB 或 AOF 持久化

**收益**：
- Redis 重启后数据不丢失
- 提高数据可靠性

**实施难度**：低（30 分钟）

**配置方法**：
```bash
# redis.conf
save 900 1       # 900 秒内至少 1 个键被修改，则保存
save 300 10      # 300 秒内至少 10 个键被修改，则保存
save 60 10000    # 60 秒内至少 10000 个键被修改，则保存
```

---

### 数据量对比

#### 当前状态
```
总 Redis 占用：约 70 MB
├── 区块数据：8-10 MB (14%)
├── AI 数据：60 MB (86%)
├── 下注数据：1.5 MB (2%)
└── 配置数据：3.4 KB (0%)
```

#### 优化后（建议 1 + 2）
```
总 Redis 占用：约 15 MB
├── 区块数据：8-10 MB (67%)
├── AI 数据：6 MB (40%)
├── 下注数据：75 KB (0.5%)
└── 配置数据：3.4 KB (0%)
```

**节省空间**：55 MB（78.6%）

---

## 结论

### 核心数据

1. **区块数据**：30000 条（8-10 MB）
   - 存储位置：Redis `tron:blocks` + `tron:block:{height}`
   - 清理策略：自动清理，保持最新 30000 条
   - 加载优化：动态计算，减少 0-99% 的数据加载

2. **AI 数据**：最多 60 MB
   - 存储位置：Redis `tron:ai:predictions:*`
   - 清理策略：自动清理，保持最新 10000 条/组合
   - **优化潜力**：可减少到 6 MB（节省 54 MB）

3. **下注数据**：最多 1.5 MB
   - 存储位置：Redis `tron:bets:*`
   - 清理策略：自动清理，保持最新 10000 条
   - **优化潜力**：可减少到 75 KB（节省 1.425 MB）

4. **配置数据**：3.4 KB
   - 存储位置：Redis `tron:config:*`
   - 清理策略：手动清除

### 优化优先级

1. **高优先级**：限制 AI 预测历史数量（节省 54 MB）
2. **中优先级**：限制下注记录数量（节省 1.425 MB）
3. **低优先级**：添加 Redis 持久化配置

---

**报告完成时间**：2024年  
**总 Redis 占用**：约 70 MB  
**优化潜力**：55 MB（78.6%）  
**核心文件**：`backend/src/redis.ts`, `backend/src/api.ts`
