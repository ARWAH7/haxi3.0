# 快速诊断 - 数据加载问题

## 🚨 立即检查

### 1. 打开浏览器控制台（F12），粘贴以下代码：

```javascript
// 诊断脚本
console.log('=== 数据加载诊断 ===');
console.log('1. 当前规则:', window.debugApp?.activeRule);
console.log('2. 区块数量:', window.debugApp?.allBlocks?.length);
console.log('3. 缓存大小:', window.debugApp?.blocksCache?.size);
console.log('4. WebSocket 状态:', window.debugApp?.wsConnected);
console.log('5. 加载状态:', window.debugApp?.isLoading);

if (window.debugApp?.allBlocks?.length > 0) {
  console.log('✅ 有数据');
  console.log('   最新区块:', window.debugApp.allBlocks[0]?.height);
  console.log('   最旧区块:', window.debugApp.allBlocks[window.debugApp.allBlocks.length - 1]?.height);
} else {
  console.log('❌ 没有数据');
}

if (window.debugApp?.blocksCache?.size > 0) {
  console.log('✅ 有缓存');
  console.log('   缓存规则:', Array.from(window.debugApp.blocksCache.keys()));
} else {
  console.log('❌ 没有缓存');
}

console.log('==================');
```

---

## 🔍 根据诊断结果判断问题

### 情况1：没有数据，没有缓存

**可能原因**：
- 后端服务未启动
- Redis 中没有数据
- API 请求失败

**解决步骤**：

1. **检查后端服务**：
   ```bash
   # 在浏览器中访问
   http://localhost:3001/health
   
   # 应该返回：{"status":"ok","timestamp":...}
   ```

2. **检查 Redis 数据**：
   ```bash
   redis-cli
   LLEN tron:blocks
   # 应该返回一个大于 0 的数字
   ```

3. **检查 API 请求**：
   - 打开 Network 面板
   - 刷新页面
   - 查找 `/api/blocks` 请求
   - 检查状态码和响应内容

---

### 情况2：有缓存，但没有显示数据

**可能原因**：
- 缓存数据为空数组
- `setAllBlocks` 未正确更新状态
- 组件渲染问题

**解决步骤**：

1. **检查缓存内容**：
   ```javascript
   // 在控制台执行
   const cache = window.debugApp.blocksCache;
   cache.forEach((value, key) => {
     console.log(`规则 ${key}: ${value.length} 条数据`);
   });
   ```

2. **如果缓存数据为空**：
   ```javascript
   // 清除缓存
   localStorage.clear();
   // 刷新页面
   location.reload();
   ```

---

### 情况3：有数据，但页面不显示

**可能原因**：
- 组件渲染问题
- CSS 样式问题
- 数据格式问题

**解决步骤**：

1. **检查数据格式**：
   ```javascript
   // 在控制台执行
   console.log('第一条数据:', window.debugApp.allBlocks[0]);
   // 应该包含：height, hash, type, sizeType 等字段
   ```

2. **检查组件状态**：
   - 打开 React DevTools
   - 查找 App 组件
   - 检查 `allBlocks` 状态

---

### 情况4：切换规则后数据不更新

**可能原因**：
- `loadHistoryBlocks` 未被调用
- 缓存逻辑错误
- useEffect 依赖项问题

**解决步骤**：

1. **手动触发加载**：
   ```javascript
   // 在控制台执行（需要先暴露函数）
   // 这个功能目前不可用，需要修改代码
   ```

2. **检查 useEffect 是否触发**：
   - 在控制台查看是否有 `[规则变化]` 日志
   - 如果没有，说明 useEffect 未触发

3. **临时解决方案**：
   - 刷新页面（F5）
   - 或者点击其他规则再切换回来

---

## 🛠️ 紧急修复方案

如果以上方法都不行，尝试以下紧急修复：

### 方案1：清除所有缓存和状态

```javascript
// 在浏览器控制台执行
localStorage.clear();
sessionStorage.clear();
location.reload();
```

### 方案2：强制重新加载数据

由于当前代码没有暴露 `loadHistoryBlocks` 函数，我需要修改代码来添加这个功能。

---

## 📋 需要提供的信息

请在浏览器控制台执行诊断脚本，然后告诉我：

1. **诊断脚本的输出结果**（完整复制）
2. **浏览器控制台的错误信息**（如果有）
3. **Network 面板的请求状态**：
   - `/api/blocks` 请求的状态码
   - 响应内容（Response）
4. **后端控制台的日志**（最近的 20 行）

有了这些信息，我可以准确定位问题并提供修复方案。

---

## 🔧 代码修复建议

如果问题是由于代码逻辑错误导致的，我可能需要修改以下部分：

1. **loadHistoryBlocks 函数**：
   - 检查缓存逻辑
   - 检查 API 请求逻辑
   - 检查错误处理

2. **useEffect 依赖项**：
   - 确保规则变化时触发加载
   - 避免不必要的重新加载

3. **缓存同步逻辑**：
   - 确保 WebSocket 更新时同步缓存
   - 确保缓存清理逻辑正确

---

请先运行诊断脚本，然后提供结果，我会根据具体情况提供修复方案！
