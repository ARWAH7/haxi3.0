# 🧪 优化效果测试指南

## 测试步骤

### 1. 启动后端服务

```bash
cd backend
npm run dev
```

**预期输出**:
```
[Redis] ✅ 连接成功
[WebSocket] 正在启动...
[API] 🚀 REST API 启动在端口 3001
[TRON Listener] 正在启动...
✅ 所有服务启动成功！
```

### 2. 启动前端服务

```bash
npm run dev
```

### 3. 打开浏览器测试

访问: `http://localhost:5173`

### 4. 测试场景

#### 场景1：规则步长 1（基准测试）

1. 选择"单区块"规则
2. 打开浏览器开发者工具（F12）→ Console
3. 观察日志输出

**预期日志**:
```
[API] 🚀 正在从后端加载过滤后的数据...
[API] 规则: 单区块, 步长: 1, 偏移: 0, 需要: 317 条
[API] ✅ 后端过滤完成: 返回 317 条数据
[API] 📊 过滤统计: 原始 317 条 → 过滤后 317 条 → 返回 317 条
[API] 💾 内存节省: 0.0%
```

#### 场景2：规则步长 20（中等优化）

1. 选择"20区块"规则
2. 观察日志输出

**预期日志**:
```
[API] 🚀 正在从后端加载过滤后的数据...
[API] 规则: 20区块, 步长: 20, 偏移: 0, 需要: 317 条
[API] ✅ 后端过滤完成: 返回 317 条数据
[API] 📊 过滤统计: 原始 6336 条 → 过滤后 317 条 → 返回 317 条
[API] 💾 内存节省: 95.0%
```

#### 场景3：规则步长 100（最大优化）

1. 选择"100区块"规则
2. 观察日志输出

**预期日志**:
```
[API] 🚀 正在从后端加载过滤后的数据...
[API] 规则: 100区块, 步长: 100, 偏移: 0, 需要: 317 条
[API] ✅ 后端过滤完成: 返回 317 条数据
[API] 📊 过滤统计: 原始 31680 条 → 过滤后 317 条 → 返回 317 条
[API] 💾 内存节省: 99.0%
```

### 5. 内存监控测试

#### 打开 Chrome 性能监控

1. 按 F12 打开开发者工具
2. 切换到 "Performance Monitor" 标签
   - 如果没有，点击 "More tools" → "Performance Monitor"
3. 观察 "JS heap size" 指标

#### 测试步骤

1. **规则步长 1**: 记录内存占用 A
2. **规则步长 20**: 记录内存占用 B
3. **规则步长 100**: 记录内存占用 C

**预期结果**:
- A ≈ B ≈ C（内存占用基本相同）
- 优化前：A < B < C（内存占用随步长增加）

### 6. 网络流量测试

#### 打开 Chrome 网络监控

1. 按 F12 打开开发者工具
2. 切换到 "Network" 标签
3. 刷新页面

#### 观察指标

- **请求 URL**: `/api/blocks?limit=317&ruleValue=100&startBlock=0`
- **响应大小**: 应该在 ~50-100 KB 范围内
- **优化前**: 响应大小可能达到 5-15 MB

### 7. 实时数据测试

#### 测试步骤

1. 选择"100区块"规则
2. 等待新区块到达
3. 观察 Console 日志

**预期日志**:
```
[Redis WS] 📦 新区块: 67890123 (ODD, BIG)
[WebSocket] ⏭️ 跳过不符合规则的区块: 67890123
```

或者（如果符合规则）:
```
[Redis WS] 📦 新区块: 67890100 (EVEN, SMALL)
[全局状态] allBlocks 更新: 318 个区块
```

---

## 性能对比表

### 优化前 vs 优化后

| 指标 | 规则步长 1 | 规则步长 20 | 规则步长 100 |
|-----|-----------|------------|-------------|
| **优化前** |
| 网络传输 | ~150 KB | ~3 MB | ~15 MB |
| 内存占用 | ~150 KB | ~3 MB | ~15 MB |
| 加载时间 | ~0.5s | ~2s | ~5s |
| **优化后** |
| 网络传输 | ~150 KB | ~150 KB | ~150 KB |
| 内存占用 | ~150 KB | ~150 KB | ~150 KB |
| 加载时间 | ~0.5s | ~0.5s | ~0.5s |
| **优化效果** |
| 网络减少 | 0% | **95%** | **99%** |
| 内存减少 | 0% | **95%** | **99%** |
| 速度提升 | 1x | **4x** | **10x** |

---

## 常见问题

### Q1: 看不到优化日志？

**A**: 确保浏览器开发者工具的 Console 已打开，并且没有过滤日志。

### Q2: 内存占用没有明显变化？

**A**: 
1. 确保后端服务正在运行
2. 检查 Network 标签，确认请求 URL 包含 `ruleValue` 参数
3. 清除浏览器缓存后重试

### Q3: 数据显示不完整？

**A**: 
1. 检查后端日志，确认过滤逻辑正常
2. 增加 `requiredDataCount` 的缓冲系数
3. 检查走势路和珠盘路的行数配置

### Q4: WebSocket 实时数据不更新？

**A**: 
1. 确认 WebSocket 连接状态（页面顶部显示）
2. 检查后端 TRON 监听服务是否正常
3. 查看 Console 是否有 WebSocket 错误

---

## 验收标准

### ✅ 优化成功的标志

1. **日志输出正确**
   - 显示"后端过滤完成"
   - 显示"内存节省"百分比
   - 大规则步长显示 95-99% 节省

2. **内存占用稳定**
   - 不同规则步长的内存占用基本相同
   - 不再触发频繁的内存清理

3. **加载速度快**
   - 规则切换响应迅速（< 1 秒）
   - 初始加载快速（< 1 秒）

4. **功能正常**
   - 走势路显示正常
   - 珠盘路显示正常
   - 实时数据更新正常

---

## 回滚方案

如果优化后出现问题，可以回滚到优化前的版本：

```bash
# 回滚后端
cd backend/src
git checkout HEAD~1 api.ts

# 回滚前端
git checkout HEAD~1 App.tsx
```

---

## 技术支持

如有任何问题，请查看:
- `OPTIMIZATION_REPORT.md` - 详细优化报告
- Console 日志 - 实时监控信息
- Network 标签 - 网络请求详情

**测试完成时间**: 2026-02-06
