# 前端数据存储完整报告

## 报告概述

本报告详细分析了前端保存的所有数据，包括区块数据、配置数据、缓存数据、AI 预测数据、下注数据等。

**生成时间**：2024年  
**分析范围**：所有前端 React State、内存缓存、后端 Redis 存储

---

## 数据存储架构

### 存储层级

```
前端数据存储
├── 1. React State（内存）
│   ├── 区块数据
│   ├── 配置数据
│   ├── UI 状态
│   ├── AI 预测数据
│   └── 下注数据
├── 2. 内存缓存（Map）
│   └── 多规则区块缓存
└── 3. 后端 Redis（持久化）
    ├── 配置数据
    ├── AI 预测历史
    ├── 下注记录
    └── 模型统计
```

---

## 第一部分：区块数据（BlockData）

### 1.1 当前显示的区块数据

**存储位置**：`App.tsx` - `allBlocks` State

**数据结构**：
```typescript
interface BlockData {
  height: number;        // 区块高度
  hash: string;          // 区块哈希
  resultValue: number;   // 结果值（0-9）
  type: BlockType;       // 单双类型（ODD/EVEN）
  sizeType: SizeType;    // 大小类型（BIG/SMALL）
  timestamp: string | number; // 时间戳
}
```

**数据量**：
- 单个规则：264 条数据
- 单条数据大小：约 0.5 KB
- 总大小：264 × 0.5 KB = **132 KB**

**数据来源**：
- 从后端 API 加载（`/api/blocks`）
- WebSocket 实时推送

**生命周期**：
- 创建：首次加载或规则切换时
- 更新：WebSocket 推送新区块时
- 清除：规则切换时（替换为新规则的数据）

---

### 1.2 多规则缓存数据

**存储位置**：`App.tsx` - `blocksCache` State

**数据结构**：
```typescript
interface CacheEntry {
  data: BlockData[];     // 区块数据数组
  timestamp: number;     // 缓存时间戳
  ruleId: string;        // 规则 ID
}

// 缓存结构
Map<string, CacheEntry>
// Key: "ruleValue-startBlock" (例如: "1-0", "20-0", "60-0")
```

**数据量**：
- 默认规则数量：8 个（步长 1, 2, 3, 5, 10, 20, 60, 100）
- 每个规则：264 条数据 × 0.5 KB = 132 KB
- 总大小：8 × 132 KB = **1.056 MB**

**数据来源**：
- 首次启动时并行加载所有规则
- WebSocket 实时同步更新

**生命周期**：
- 创建：首次启动时预加载
- 更新：WebSocket 推送新区块时同步更新
- 过期：30 秒后标记为过期（但不删除）
- 清除：规则删除时清除对应缓存

---

### 1.3 区块数据总结

| 数据项 | 存储位置 | 数据量 | 大小 | 生命周期 |
|--------|---------|--------|------|---------|
| 当前显示区块 | React State | 264 条 | 132 KB | 规则切换时替换 |
| 多规则缓存 | React State (Map) | 8 × 264 条 | 1.056 MB | 持续更新 |
| **总计** | - | **2,112 条** | **1.188 MB** | - |

---

## 第二部分：配置数据

### 2.1 主题颜色配置

**存储位置**：
- 前端：`App.tsx` - `themeColors` State
- 后端：Redis - `config:theme`

**数据结构**：
```typescript
interface ThemeColors {
  odd: string;    // 单数颜色（例如: "#ef4444"）
  even: string;   // 双数颜色（例如: "#14b8a6"）
  big: string;    // 大数颜色（例如: "#f97316"）
  small: string;  // 小数颜色（例如: "#6366f1"）
}
```

**数据量**：
- 4 个颜色值
- 单个颜色：7 字节（例如: "#ef4444"）
- 总大小：约 **28 字节**

**数据来源**：
- 从后端 Redis 加载
- 用户修改后保存到后端

**生命周期**：
- 加载：应用启动时
- 更新：用户修改颜色时（防抖 1 秒）
- 持久化：保存到后端 Redis

---

### 2.2 采样规则配置

**存储位置**：
- 前端：`App.tsx` - `rules` State
- 后端：Redis - `config:rules`

**数据结构**：
```typescript
interface IntervalRule {
  id: string;              // 规则 ID
  label: string;           // 规则标签（例如: "3秒"）
  value: number;           // 步长值（例如: 1, 20, 60, 100）
  startBlock: number;      // 起始区块（通常为 0）
  trendRows: number;       // 走势图行数（通常为 6）
  beadRows: number;        // 珠盘路行数（通常为 6）
  dragonThreshold?: number; // 长龙阈值（通常为 3）
}
```

**数据量**：
- 默认规则数量：8 个
- 单个规则：约 100 字节
- 总大小：8 × 100 = **800 字节**

**数据来源**：
- 从后端 Redis 加载
- 用户创建/修改/删除规则

**生命周期**：
- 加载：应用启动时
- 更新：用户修改规则时（防抖 2 秒）
- 持久化：保存到后端 Redis

---

### 2.3 激活规则 ID

**存储位置**：
- 前端：`App.tsx` - `activeRuleId` State
- 后端：Redis - `config:activeRule`

**数据结构**：
```typescript
string // 例如: "1", "20", "60", "100"
```

**数据量**：
- 单个字符串
- 总大小：约 **10 字节**

**数据来源**：
- 从后端 Redis 加载
- 用户切换规则时更新

**生命周期**：
- 加载：应用启动时
- 更新：用户切换规则时（防抖 0.5 秒）
- 持久化：保存到后端 Redis

---

### 2.4 关注模式配置

**存储位置**：
- 前端：`App.tsx` - `followedPatterns` State
- 后端：Redis - `config:followedPatterns`

**数据结构**：
```typescript
interface FollowedPattern {
  ruleId: string;           // 规则 ID
  type: 'parity' | 'size';  // 类型（单双/大小）
  mode: 'trend' | 'bead';   // 模式（走势/珠盘）
  rowId?: number;           // 行号（珠盘路专用）
}
```

**数据量**：
- 用户关注的模式数量：0-50 个（取决于用户）
- 单个模式：约 50 字节
- 总大小：50 × 50 = **2.5 KB**（最大）

**数据来源**：
- 从后端 Redis 加载
- 用户添加/删除关注模式

**生命周期**：
- 加载：应用启动时
- 更新：用户修改关注模式时（防抖 2 秒）
- 持久化：保存到后端 Redis

---

### 2.5 配置数据总结

| 数据项 | 存储位置 | 数据量 | 大小 | 持久化 |
|--------|---------|--------|------|--------|
| 主题颜色 | React State + Redis | 4 个颜色 | 28 字节 | ✅ |
| 采样规则 | React State + Redis | 8 个规则 | 800 字节 | ✅ |
| 激活规则 ID | React State + Redis | 1 个字符串 | 10 字节 | ✅ |
| 关注模式 | React State + Redis | 0-50 个 | 0-2.5 KB | ✅ |
| **总计** | - | - | **约 3.3 KB** | - |

---

## 第三部分：AI 预测数据

### 3.1 AI 预测历史

**存储位置**：
- 前端：`AIPrediction.tsx` - `history` State
- 后端：Redis - `ai:predictions`

**数据结构**：
```typescript
interface PredictionHistoryItem {
  id: string;                    // 预测 ID
  timestamp: number;             // 时间戳
  targetHeight?: number;         // 目标区块高度
  shouldPredict: boolean;        // 是否应该预测
  nextParity: 'ODD' | 'EVEN' | 'NEUTRAL';  // 预测单双
  parityConfidence: number;      // 单双置信度
  nextSize: 'BIG' | 'SMALL' | 'NEUTRAL';   // 预测大小
  sizeConfidence: number;        // 大小置信度
  analysis: string;              // 分析文本
  detectedCycle: string;         // 检测到的周期
  riskLevel: 'LOW' | 'MEDIUM' | 'HIGH';  // 风险等级
  entropyScore: number;          // 熵分数
  resolved: boolean;             // 是否已验证
  actualParity?: BlockType;      // 实际单双
  actualSize?: SizeType;         // 实际大小
  isParityCorrect?: boolean;     // 单双预测是否正确
  isSizeCorrect?: boolean;       // 大小预测是否正确
  ruleId?: string;               // 规则 ID
}
```

**数据量**：
- 预测历史数量：0-1000 条（取决于使用时长）
- 单条预测：约 300 字节
- 总大小：1000 × 300 = **300 KB**（最大）

**数据来源**：
- AI 模型生成预测
- 保存到后端 Redis

**生命周期**：
- 创建：AI 生成预测时
- 更新：区块验证后更新结果
- 清除：用户手动清除或达到上限

---

### 3.2 AI 模型统计

**存储位置**：
- 前端：`AIPrediction.tsx` - `modelStats` State
- 后端：Redis - `ai:modelStats`

**数据结构**：
```typescript
Record<string, { total: number; correct: number }>
// 例如:
{
  "model-1": { total: 100, correct: 65 },
  "model-2": { total: 150, correct: 90 },
  ...
}
```

**数据量**：
- 模型数量：约 10 个
- 单个模型统计：约 50 字节
- 总大小：10 × 50 = **500 字节**

**数据来源**：
- AI 预测验证后累计
- 保存到后端 Redis

**生命周期**：
- 创建：首次预测时
- 更新：每次预测验证后
- 清除：用户手动清除

---

### 3.3 AI 数据总结

| 数据项 | 存储位置 | 数据量 | 大小 | 持久化 |
|--------|---------|--------|------|--------|
| 预测历史 | React State + Redis | 0-1000 条 | 0-300 KB | ✅ |
| 模型统计 | React State + Redis | 10 个模型 | 500 字节 | ✅ |
| **总计** | - | - | **约 300.5 KB** | - |

---

## 第四部分：下注数据

### 4.1 下注记录

**存储位置**：
- 前端：`SimulatedBetting.tsx` - `bets` State
- 后端：Redis - `bets:records`

**数据结构**：
```typescript
interface BetRecord {
  id?: string;                   // 记录 ID
  timestamp: number;             // 时间戳
  blockHeight: number;           // 区块高度
  betAmount: number;             // 下注金额
  betType: 'parity' | 'size';    // 下注类型
  betChoice: BlockType | SizeType; // 下注选择
  result: 'win' | 'lose' | 'pending'; // 结果
  payout?: number;               // 赔付金额
  ruleId?: string;               // 规则 ID
}
```

**数据量**：
- 下注记录数量：0-500 条（默认限制）
- 单条记录：约 150 字节
- 总大小：500 × 150 = **75 KB**（最大）

**数据来源**：
- 用户手动下注或自动下注
- 保存到后端 Redis

**生命周期**：
- 创建：下注时
- 更新：区块验证后更新结果
- 清除：用户手动清除或达到上限

---

### 4.2 账户余额

**存储位置**：
- 前端：`SimulatedBetting.tsx` - `balance` State
- 后端：Redis - `bets:balance`

**数据结构**：
```typescript
number // 例如: 10000
```

**数据量**：
- 单个数字
- 总大小：约 **8 字节**

**数据来源**：
- 初始值：10000
- 下注后更新

**生命周期**：
- 加载：应用启动时
- 更新：每次下注后
- 持久化：保存到后端 Redis

---

### 4.3 全局指标

**存储位置**：
- 前端：`SimulatedBetting.tsx` - `globalMetrics` State
- 后端：Redis - `bets:globalMetrics`

**数据结构**：
```typescript
interface GlobalMetrics {
  peakBalance: number;    // 峰值余额
  maxDrawdown: number;    // 最大回撤
}
```

**数据量**：
- 2 个数字
- 总大小：约 **16 字节**

**数据来源**：
- 下注后计算更新

**生命周期**：
- 加载：应用启动时
- 更新：每次下注后
- 持久化：保存到后端 Redis

---

### 4.4 托管任务

**存储位置**：
- 前端：`SimulatedBetting.tsx` - `tasks` State
- 后端：Redis - `bets:tasks`

**数据结构**：
```typescript
interface AutoTask {
  id: string;                    // 任务 ID
  name: string;                  // 任务名称
  ruleId: string;                // 规则 ID
  enabled: boolean;              // 是否启用
  config: StrategyConfig;        // 策略配置
  stats: {                       // 统计数据
    totalBets: number;
    wins: number;
    losses: number;
    currentBalance: number;
    peakBalance: number;
    maxDrawdown: number;
  };
}
```

**数据量**：
- 托管任务数量：0-20 个（取决于用户）
- 单个任务：约 500 字节
- 总大小：20 × 500 = **10 KB**（最大）

**数据来源**：
- 用户创建托管任务

**生命周期**：
- 创建：用户创建任务时
- 更新：任务执行后更新统计
- 清除：用户删除任务

---

### 4.5 下注配置

**存储位置**：
- 前端：`SimulatedBetting.tsx` - `config` State
- 后端：Redis - `bets:config`

**数据结构**：
```typescript
interface SimConfig {
  initialBalance: number;  // 初始余额
  odds: number;            // 赔率
}
```

**数据量**：
- 2 个数字
- 总大小：约 **16 字节**

**数据来源**：
- 用户配置

**生命周期**：
- 加载：应用启动时
- 更新：用户修改配置时
- 持久化：保存到后端 Redis

---

### 4.6 下注数据总结

| 数据项 | 存储位置 | 数据量 | 大小 | 持久化 |
|--------|---------|--------|------|--------|
| 下注记录 | React State + Redis | 0-500 条 | 0-75 KB | ✅ |
| 账户余额 | React State + Redis | 1 个数字 | 8 字节 | ✅ |
| 全局指标 | React State + Redis | 2 个数字 | 16 字节 | ✅ |
| 托管任务 | React State + Redis | 0-20 个 | 0-10 KB | ✅ |
| 下注配置 | React State + Redis | 2 个数字 | 16 字节 | ✅ |
| **总计** | - | - | **约 85 KB** | - |

---

## 第五部分：UI 状态数据

### 5.1 UI 状态列表

**存储位置**：`App.tsx` - 各种 State

| 状态名称 | 数据类型 | 大小 | 说明 |
|---------|---------|------|------|
| showSettings | boolean | 1 字节 | 是否显示设置面板 |
| showQuickSwitcher | boolean | 1 字节 | 是否显示快速切换器 |
| activeTab | string | 20 字节 | 当前激活的标签页 |
| wsConnected | boolean | 1 字节 | WebSocket 连接状态 |
| memoryUsage | object | 24 字节 | 内存使用情况 |
| isLoadingConfig | boolean | 1 字节 | 配置加载状态 |
| ruleSearchQuery | string | 0-100 字节 | 规则搜索查询 |
| switcherSearchQuery | string | 0-100 字节 | 切换器搜索查询 |
| ruleSortBy | string | 10 字节 | 规则排序方式 |
| selectedRuleIds | Set | 0-100 字节 | 选中的规则 ID |
| editingRule | object | 0-100 字节 | 正在编辑的规则 |
| showBatchModal | boolean | 1 字节 | 是否显示批量模态框 |
| batchText | string | 0-1000 字节 | 批量文本 |
| searchQuery | string | 0-100 字节 | 搜索查询 |
| isLoading | boolean | 1 字节 | 加载状态 |
| isSyncing | boolean | 1 字节 | 同步状态 |
| error | string | 0-200 字节 | 错误信息 |
| connectionError | string | 0-200 字节 | 连接错误信息 |

**总大小**：约 **2 KB**（最大）

**生命周期**：
- 临时状态，刷新页面后重置
- 不持久化

---

## 总结报告

### 数据存储总览

| 数据类别 | 前端内存 | 后端 Redis | 总大小 | 持久化 |
|---------|---------|-----------|--------|--------|
| **区块数据** | 1.188 MB | ❌ | 1.188 MB | ❌ |
| **配置数据** | 3.3 KB | ✅ | 3.3 KB | ✅ |
| **AI 数据** | 300.5 KB | ✅ | 300.5 KB | ✅ |
| **下注数据** | 85 KB | ✅ | 85 KB | ✅ |
| **UI 状态** | 2 KB | ❌ | 2 KB | ❌ |
| **总计** | **1.578 MB** | **388.8 KB** | **1.578 MB** | - |

---

### 关键发现

#### 1. 区块数据占主导地位
- **区块数据占总内存的 75.3%**（1.188 MB / 1.578 MB）
- 多规则缓存机制导致数据量增加
- 每个规则 264 条数据 × 8 个规则 = 2,112 条数据

#### 2. 配置数据很小
- **配置数据仅占 0.2%**（3.3 KB / 1.578 MB）
- 已持久化到后端 Redis
- 刷新页面后无需重新配置

#### 3. AI 和下注数据适中
- **AI 数据占 19%**（300.5 KB / 1.578 MB）
- **下注数据占 5.4%**（85 KB / 1.578 MB）
- 已持久化到后端 Redis
- 数据量随使用时长增长

#### 4. UI 状态数据可忽略
- **UI 状态仅占 0.1%**（2 KB / 1.578 MB）
- 临时状态，不需要持久化

---

### 优化建议

#### 建议 1：实施 IndexedDB 持久化（阶段 2）

**目标**：将区块数据持久化到 IndexedDB

**收益**：
- 刷新页面后无需重新加载（50-70ms → 5-10ms）
- 支持离线使用
- 减少后端请求

**实施难度**：中（3-4 小时）

**数据量**：
- 区块数据：1.188 MB
- IndexedDB 容量：几十 MB 到几百 MB
- 完全足够

---

#### 建议 2：限制 AI 预测历史数量

**目标**：限制 AI 预测历史最多保存 500 条

**收益**：
- 减少内存占用（300 KB → 150 KB）
- 提高查询性能
- 减少后端存储

**实施难度**：低（30 分钟）

**实施方法**：
```typescript
// 在保存预测时限制数量
if (history.length > 500) {
  history = history.slice(0, 500);
}
```

---

#### 建议 3：限制下注记录数量

**目标**：限制下注记录最多保存 200 条

**收益**：
- 减少内存占用（75 KB → 30 KB）
- 提高查询性能
- 减少后端存储

**实施难度**：低（30 分钟）

**实施方法**：
```typescript
// 在保存下注记录时限制数量
if (bets.length > 200) {
  bets = bets.slice(0, 200);
}
```

---

### 内存占用对比

#### 当前状态
```
总内存：1.578 MB
├── 区块数据：1.188 MB (75.3%)
├── AI 数据：300.5 KB (19%)
├── 下注数据：85 KB (5.4%)
├── 配置数据：3.3 KB (0.2%)
└── UI 状态：2 KB (0.1%)
```

#### 优化后（建议 2 + 3）
```
总内存：1.363 MB
├── 区块数据：1.188 MB (87.2%)
├── AI 数据：150 KB (11%)
├── 下注数据：30 KB (2.2%)
├── 配置数据：3.3 KB (0.2%)
└── UI 状态：2 KB (0.1%)
```

**节省内存**：215 KB（13.6%）

---

### 数据流向图

```
用户操作
    ↓
前端 React State（内存）
    ├─ 区块数据（1.188 MB）
    │   ├─ 当前显示：264 条
    │   └─ 多规则缓存：8 × 264 条
    │
    ├─ 配置数据（3.3 KB）
    │   ├─ 主题颜色 → Redis
    │   ├─ 采样规则 → Redis
    │   ├─ 激活规则 → Redis
    │   └─ 关注模式 → Redis
    │
    ├─ AI 数据（300.5 KB）
    │   ├─ 预测历史 → Redis
    │   └─ 模型统计 → Redis
    │
    └─ 下注数据（85 KB）
        ├─ 下注记录 → Redis
        ├─ 账户余额 → Redis
        ├─ 全局指标 → Redis
        ├─ 托管任务 → Redis
        └─ 下注配置 → Redis
```

---

## 结论

### 核心数据

1. **区块数据**：1.188 MB（75.3%）
   - 当前显示：264 条（132 KB）
   - 多规则缓存：8 × 264 条（1.056 MB）
   - **不持久化**，刷新页面后需要重新加载

2. **配置数据**：3.3 KB（0.2%）
   - 主题颜色、采样规则、激活规则、关注模式
   - **已持久化**到后端 Redis

3. **AI 数据**：300.5 KB（19%）
   - 预测历史、模型统计
   - **已持久化**到后端 Redis

4. **下注数据**：85 KB（5.4%）
   - 下注记录、账户余额、全局指标、托管任务、下注配置
   - **已持久化**到后端 Redis

### 优化优先级

1. **高优先级**：实施 IndexedDB 持久化（阶段 2）
   - 解决区块数据刷新页面后需要重新加载的问题
   - 性能提升 90-95%

2. **中优先级**：限制 AI 预测历史数量
   - 减少内存占用 150 KB
   - 提高查询性能

3. **低优先级**：限制下注记录数量
   - 减少内存占用 45 KB
   - 提高查询性能

---

**报告完成时间**：2024年  
**总内存占用**：1.578 MB  
**持久化数据**：388.8 KB  
**优化潜力**：215 KB（13.6%）
