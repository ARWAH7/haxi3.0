# é—®é¢˜ 2ï¼šåç«¯æ•°æ®è¿‡æ»¤æ–¹æ¡ˆæ·±åº¦åˆ†æ

## ğŸ“‹ é—®é¢˜èƒŒæ™¯

### å½“å‰å®ç°
åç«¯ä» Redis åŠ è½½ 30,000 æ¡åŸå§‹æ•°æ®åˆ°å†…å­˜ï¼Œç„¶ååœ¨å†…å­˜ä¸­è¿‡æ»¤ï¼Œæœ€åè¿”å› 264 æ¡æ•°æ®ã€‚

### ç”¨æˆ·è§„åˆ™ç¤ºä¾‹
```
3ç§’   (æ­¥é•¿ 1)   â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
6ç§’   (æ­¥é•¿ 2)   â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
9ç§’   (æ­¥é•¿ 3)   â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
15ç§’  (æ­¥é•¿ 5)   â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
30ç§’  (æ­¥é•¿ 10)  â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
1åˆ†é’Ÿ (æ­¥é•¿ 20)  â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
3åˆ†é’Ÿ (æ­¥é•¿ 60)  â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
5åˆ†é’Ÿ (æ­¥é•¿ 100) â†’ éœ€è¦ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
```

---

## ğŸ” æ–¹æ¡ˆå¯¹æ¯”åˆ†æ

### æ–¹æ¡ˆ Aï¼šå†…å­˜è¿‡æ»¤ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

#### å·¥ä½œæµç¨‹
```
1. Redis åŠ è½½ 30,000 æ¡åŸå§‹æ•°æ® â†’ å†…å­˜
2. åœ¨å†…å­˜ä¸­éå† 30,000 æ¡æ•°æ®
3. åº”ç”¨è§„åˆ™è¿‡æ»¤ï¼ˆheight % ruleValue === 0ï¼‰
4. è¿”å›å‰ 264 æ¡ç¬¦åˆè§„åˆ™çš„æ•°æ®
```

#### ä»£ç ç¤ºä¾‹
```typescript
// 1. ä» Redis åŠ è½½åŸå§‹æ•°æ®
const allBlocks = await getBlocks(30000);  // åŠ è½½ 30,000 æ¡

// 2. åœ¨å†…å­˜ä¸­è¿‡æ»¤
let filteredBlocks = allBlocks;
if (ruleValue > 1) {
  filteredBlocks = allBlocks.filter(block => {
    if (startBlock > 0) {
      return block.height >= startBlock && (block.height - startBlock) % ruleValue === 0;
    }
    return block.height % ruleValue === 0;
  });
}

// 3. è¿”å›å‰ 264 æ¡
const resultBlocks = filteredBlocks.slice(0, 264);
```

#### æ€§èƒ½åˆ†æ

**æ­¥é•¿ä¸º 1ï¼ˆ3ç§’è§„åˆ™ï¼‰**ï¼š
- Redis è¯»å–ï¼š30,000 æ¡ Ã— 0.5KB = 15MB
- å†…å­˜è¿‡æ»¤ï¼šéå† 30,000 æ¡ï¼Œå…¨éƒ¨ç¬¦åˆ
- è¿”å›æ•°æ®ï¼š264 æ¡
- æ•°æ®æµªè´¹ï¼š99.1%ï¼ˆ30,000 â†’ 264ï¼‰

**æ­¥é•¿ä¸º 20ï¼ˆ1åˆ†é’Ÿè§„åˆ™ï¼‰**ï¼š
- Redis è¯»å–ï¼š30,000 æ¡ Ã— 0.5KB = 15MB
- å†…å­˜è¿‡æ»¤ï¼šéå† 30,000 æ¡ï¼Œ1,500 æ¡ç¬¦åˆï¼ˆ30,000 / 20ï¼‰
- è¿”å›æ•°æ®ï¼š264 æ¡
- æ•°æ®æµªè´¹ï¼š99.1%ï¼ˆ30,000 â†’ 264ï¼‰

**æ­¥é•¿ä¸º 100ï¼ˆ5åˆ†é’Ÿè§„åˆ™ï¼‰**ï¼š
- Redis è¯»å–ï¼š30,000 æ¡ Ã— 0.5KB = 15MB
- å†…å­˜è¿‡æ»¤ï¼šéå† 30,000 æ¡ï¼Œ300 æ¡ç¬¦åˆï¼ˆ30,000 / 100ï¼‰
- è¿”å›æ•°æ®ï¼š264 æ¡
- æ•°æ®æµªè´¹ï¼š99.1%ï¼ˆ30,000 â†’ 264ï¼‰

#### ä¼˜ç‚¹
- âœ… å®ç°ç®€å•
- âœ… é€»è¾‘æ¸…æ™°
- âœ… æ˜“äºè°ƒè¯•

#### ç¼ºç‚¹
- âŒ å§‹ç»ˆåŠ è½½ 30,000 æ¡æ•°æ®ï¼Œæµªè´¹ä¸¥é‡
- âŒ å†…å­˜å ç”¨å¤§ï¼ˆ15MBï¼‰
- âŒ CPU æ¶ˆè€—é«˜ï¼ˆéå† 30,000 æ¡ï¼‰
- âŒ ç½‘ç»œä¼ è¾“æ…¢ï¼ˆRedis â†’ åº”ç”¨æœåŠ¡å™¨ï¼‰

---

### æ–¹æ¡ˆ Bï¼šRedis è¿‡æ»¤ï¼ˆæ¨èæ–¹æ¡ˆï¼‰

#### å·¥ä½œæµç¨‹
```
1. åœ¨ Redis ä¸­ä½¿ç”¨ Lua è„šæœ¬æˆ–å‘½ä»¤è¿‡æ»¤æ•°æ®
2. åªè¿”å›ç¬¦åˆè§„åˆ™çš„æ•°æ®åˆ°å†…å­˜
3. ç›´æ¥è¿”å›ç»™å‰ç«¯
```

#### Redis æ•°æ®ç»“æ„è®¾è®¡

**å½“å‰å­˜å‚¨æ–¹å¼**ï¼ˆå‡è®¾ï¼‰ï¼š
```
Redis Key: tron:blocks
Type: Sorted Set (ZSET)
Score: block.height (åŒºå—é«˜åº¦)
Value: JSON.stringify(block)
```

#### å®ç°æ–¹æ¡ˆ

##### æ–¹æ¡ˆ B1ï¼šä½¿ç”¨ Lua è„šæœ¬è¿‡æ»¤

**Lua è„šæœ¬**ï¼š
```lua
-- å‚æ•°ï¼š
-- KEYS[1]: Redis key (ä¾‹å¦‚ "tron:blocks")
-- ARGV[1]: ruleValue (æ­¥é•¿)
-- ARGV[2]: startBlock (åç§»)
-- ARGV[3]: limit (éœ€è¦çš„æ•°æ®é‡ï¼Œé»˜è®¤ 264)

local key = KEYS[1]
local ruleValue = tonumber(ARGV[1])
local startBlock = tonumber(ARGV[2])
local limit = tonumber(ARGV[3])

-- è·å–æ‰€æœ‰åŒºå—ï¼ˆæŒ‰ score é™åºï¼‰
local allBlocks = redis.call('ZREVRANGE', key, 0, -1, 'WITHSCORES')

local result = {}
local count = 0

-- éå†åŒºå—ï¼Œåº”ç”¨è§„åˆ™è¿‡æ»¤
for i = 1, #allBlocks, 2 do
  local blockData = allBlocks[i]
  local height = tonumber(allBlocks[i + 1])
  
  -- åº”ç”¨è§„åˆ™è¿‡æ»¤
  local isMatch = false
  if ruleValue <= 1 then
    isMatch = true
  elseif startBlock > 0 then
    isMatch = (height >= startBlock) and ((height - startBlock) % ruleValue == 0)
  else
    isMatch = (height % ruleValue == 0)
  end
  
  -- å¦‚æœç¬¦åˆè§„åˆ™ï¼Œæ·»åŠ åˆ°ç»“æœ
  if isMatch then
    table.insert(result, blockData)
    count = count + 1
    
    -- è¾¾åˆ°é™åˆ¶ï¼Œåœæ­¢
    if count >= limit then
      break
    end
  end
end

return result
```

**Node.js ä»£ç **ï¼š
```typescript
import { redis } from './redis';

// å®šä¹‰ Lua è„šæœ¬
const filterBlocksScript = `
  -- Lua è„šæœ¬å†…å®¹ï¼ˆå¦‚ä¸Šï¼‰
`;

// åŠ è½½è„šæœ¬åˆ° Redisï¼ˆåªéœ€åŠ è½½ä¸€æ¬¡ï¼‰
const scriptSha = await redis.scriptLoad(filterBlocksScript);

// ä½¿ç”¨è„šæœ¬è¿‡æ»¤æ•°æ®
app.get('/api/blocks', async (req, res) => {
  try {
    const limit = parseInt(req.query.limit as string) || 264;
    const ruleValue = parseInt(req.query.ruleValue as string) || 1;
    const startBlock = parseInt(req.query.startBlock as string) || 0;
    
    console.log(`[API] ğŸ“¥ è§„åˆ™è¿‡æ»¤è¯·æ±‚: æ­¥é•¿ ${ruleValue}, åç§» ${startBlock}, éœ€è¦ ${limit} æ¡`);
    
    // âœ… åœ¨ Redis ä¸­è¿‡æ»¤æ•°æ®
    const startTime = Date.now();
    const filteredData = await redis.evalsha(
      scriptSha,
      1,  // KEYS æ•°é‡
      'tron:blocks',  // KEYS[1]
      ruleValue,      // ARGV[1]
      startBlock,     // ARGV[2]
      limit           // ARGV[3]
    );
    const endTime = Date.now();
    
    console.log(`[API] âœ… Redis è¿‡æ»¤å®Œæˆ: è¿”å› ${filteredData.length} æ¡æ•°æ®ï¼Œè€—æ—¶ ${endTime - startTime}ms`);
    
    // è§£æ JSON æ•°æ®
    const resultBlocks = filteredData.map((data: string) => JSON.parse(data));
    
    res.json({
      success: true,
      data: resultBlocks,
      count: resultBlocks.length,
      metadata: {
        ruleValue,
        startBlock,
        returned: resultBlocks.length,
        requested: limit,
        processingTime: endTime - startTime,
      }
    });
  } catch (error: any) {
    console.error('[API] âŒ é”™è¯¯:', error.message);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

##### æ–¹æ¡ˆ B2ï¼šåŠ¨æ€è®¡ç®— + Redis èŒƒå›´æŸ¥è¯¢

**æ ¸å¿ƒæ€è·¯**ï¼š
1. æ ¹æ®æ­¥é•¿åŠ¨æ€è®¡ç®—éœ€è¦åŠ è½½çš„åŸå§‹æ•°æ®é‡
2. ä» Redis åŠ è½½è®¡ç®—å‡ºçš„æ•°æ®é‡
3. åœ¨å†…å­˜ä¸­å¿«é€Ÿè¿‡æ»¤

**ä»£ç ç¤ºä¾‹**ï¼š
```typescript
app.get('/api/blocks', async (req, res) => {
  try {
    const limit = parseInt(req.query.limit as string) || 264;
    const ruleValue = parseInt(req.query.ruleValue as string) || 1;
    const startBlock = parseInt(req.query.startBlock as string) || 0;
    
    // âœ… åŠ¨æ€è®¡ç®—éœ€è¦åŠ è½½çš„åŸå§‹æ•°æ®é‡
    const safetyFactor = 1.5;
    const estimatedRawBlocks = Math.ceil(limit * ruleValue * safetyFactor);
    const MAX_RAW_BLOCKS = Math.min(estimatedRawBlocks, 30000);
    
    console.log(`[API] ğŸ“¥ è§„åˆ™è¿‡æ»¤è¯·æ±‚: æ­¥é•¿ ${ruleValue}, éœ€è¦ ${limit} æ¡`);
    console.log(`[API] ğŸ“Š é¢„ä¼°åŠ è½½: ${estimatedRawBlocks} æ¡ï¼Œå®é™…åŠ è½½: ${MAX_RAW_BLOCKS} æ¡`);
    
    // âœ… ä» Redis åŠ è½½åŠ¨æ€è®¡ç®—çš„æ•°æ®é‡
    const startTime = Date.now();
    const allBlocks = await getBlocks(MAX_RAW_BLOCKS);
    const loadTime = Date.now();
    
    // âœ… åœ¨å†…å­˜ä¸­å¿«é€Ÿè¿‡æ»¤
    let filteredBlocks = allBlocks;
    if (ruleValue > 1) {
      filteredBlocks = allBlocks.filter(block => {
        if (startBlock > 0) {
          return block.height >= startBlock && (block.height - startBlock) % ruleValue === 0;
        }
        return block.height % ruleValue === 0;
      });
    }
    const filterTime = Date.now();
    
    // âœ… è¿”å›å‰ 264 æ¡
    const resultBlocks = filteredBlocks.slice(0, limit);
    const endTime = Date.now();
    
    console.log(`[API] â±ï¸ æ€§èƒ½ç»Ÿè®¡:`);
    console.log(`  - Redis åŠ è½½: ${loadTime - startTime}ms`);
    console.log(`  - å†…å­˜è¿‡æ»¤: ${filterTime - loadTime}ms`);
    console.log(`  - æ€»è€—æ—¶: ${endTime - startTime}ms`);
    console.log(`[API] âœ… è¿”å› ${resultBlocks.length} æ¡æ•°æ®`);
    
    res.json({
      success: true,
      data: resultBlocks,
      count: resultBlocks.length,
      metadata: {
        ruleValue,
        startBlock,
        totalRaw: allBlocks.length,
        totalFiltered: filteredBlocks.length,
        returned: resultBlocks.length,
        requested: limit,
        estimatedRawBlocks,
        actualRawBlocks: MAX_RAW_BLOCKS,
        performance: {
          redisLoad: loadTime - startTime,
          memoryFilter: filterTime - loadTime,
          total: endTime - startTime,
        }
      }
    });
  } catch (error: any) {
    console.error('[API] âŒ é”™è¯¯:', error.message);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### æ•°æ®åŠ è½½é‡å¯¹æ¯”

| è§„åˆ™ | æ­¥é•¿ | æ–¹æ¡ˆAï¼ˆå†…å­˜è¿‡æ»¤ï¼‰ | æ–¹æ¡ˆB1ï¼ˆLuaè„šæœ¬ï¼‰ | æ–¹æ¡ˆB2ï¼ˆåŠ¨æ€è®¡ç®—ï¼‰ | ä¼˜åŒ–æ•ˆæœ |
|------|------|------------------|------------------|-------------------|---------|
| 3ç§’ | 1 | 30,000 æ¡ | 264 æ¡ | 396 æ¡ | B1: 99.1% â†“<br>B2: 98.7% â†“ |
| 6ç§’ | 2 | 30,000 æ¡ | 264 æ¡ | 792 æ¡ | B1: 99.1% â†“<br>B2: 97.4% â†“ |
| 9ç§’ | 3 | 30,000 æ¡ | 264 æ¡ | 1,188 æ¡ | B1: 99.1% â†“<br>B2: 96.0% â†“ |
| 15ç§’ | 5 | 30,000 æ¡ | 264 æ¡ | 1,980 æ¡ | B1: 99.1% â†“<br>B2: 93.4% â†“ |
| 30ç§’ | 10 | 30,000 æ¡ | 264 æ¡ | 3,960 æ¡ | B1: 99.1% â†“<br>B2: 86.8% â†“ |
| 1åˆ†é’Ÿ | 20 | 30,000 æ¡ | 264 æ¡ | 7,920 æ¡ | B1: 99.1% â†“<br>B2: 73.6% â†“ |
| 3åˆ†é’Ÿ | 60 | 30,000 æ¡ | 264 æ¡ | 23,760 æ¡ | B1: 99.1% â†“<br>B2: 20.8% â†“ |
| 5åˆ†é’Ÿ | 100 | 30,000 æ¡ | 264 æ¡ | 30,000 æ¡ | B1: 99.1% â†“<br>B2: 0% |

### æ€§èƒ½ä¼°ç®—

#### æ–¹æ¡ˆ Aï¼šå†…å­˜è¿‡æ»¤ï¼ˆå½“å‰æ–¹æ¡ˆï¼‰

| æ“ä½œ | è€—æ—¶ä¼°ç®— | è¯´æ˜ |
|------|---------|------|
| Redis è¯»å– 30,000 æ¡ | ~300ms | ç½‘ç»œä¼ è¾“ + åºåˆ—åŒ– |
| å†…å­˜è¿‡æ»¤ 30,000 æ¡ | ~100ms | CPU è®¡ç®— |
| è¿”å› 264 æ¡ | ~10ms | ç½‘ç»œä¼ è¾“ |
| **æ€»è€—æ—¶** | **~410ms** | |

#### æ–¹æ¡ˆ B1ï¼šLua è„šæœ¬è¿‡æ»¤

| æ“ä½œ | è€—æ—¶ä¼°ç®— | è¯´æ˜ |
|------|---------|------|
| Lua è„šæœ¬æ‰§è¡Œ | ~150ms | Redis å†…éƒ¨å¤„ç† |
| è¿”å› 264 æ¡ | ~10ms | ç½‘ç»œä¼ è¾“ |
| **æ€»è€—æ—¶** | **~160ms** | |

**æ€§èƒ½æå‡**ï¼š2.5 å€ï¼ˆ410ms â†’ 160msï¼‰

#### æ–¹æ¡ˆ B2ï¼šåŠ¨æ€è®¡ç®—ï¼ˆæ­¥é•¿ 1ï¼‰

| æ“ä½œ | è€—æ—¶ä¼°ç®— | è¯´æ˜ |
|------|---------|------|
| Redis è¯»å– 396 æ¡ | ~20ms | ç½‘ç»œä¼ è¾“ + åºåˆ—åŒ– |
| å†…å­˜è¿‡æ»¤ 396 æ¡ | ~5ms | CPU è®¡ç®— |
| è¿”å› 264 æ¡ | ~10ms | ç½‘ç»œä¼ è¾“ |
| **æ€»è€—æ—¶** | **~35ms** | |

**æ€§èƒ½æå‡**ï¼š11.7 å€ï¼ˆ410ms â†’ 35msï¼‰

#### æ–¹æ¡ˆ B2ï¼šåŠ¨æ€è®¡ç®—ï¼ˆæ­¥é•¿ 20ï¼‰

| æ“ä½œ | è€—æ—¶ä¼°ç®— | è¯´æ˜ |
|------|---------|------|
| Redis è¯»å– 7,920 æ¡ | ~80ms | ç½‘ç»œä¼ è¾“ + åºåˆ—åŒ– |
| å†…å­˜è¿‡æ»¤ 7,920 æ¡ | ~20ms | CPU è®¡ç®— |
| è¿”å› 264 æ¡ | ~10ms | ç½‘ç»œä¼ è¾“ |
| **æ€»è€—æ—¶** | **~110ms** | |

**æ€§èƒ½æå‡**ï¼š3.7 å€ï¼ˆ410ms â†’ 110msï¼‰

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### æœ€ä½³æ–¹æ¡ˆï¼šæ–¹æ¡ˆ B2ï¼ˆåŠ¨æ€è®¡ç®— + å†…å­˜è¿‡æ»¤ï¼‰

#### æ¨èç†ç”±

1. **å®æ–½ç®€å•**
   - ä¸éœ€è¦ä¿®æ”¹ Redis æ•°æ®ç»“æ„
   - ä¸éœ€è¦ç¼–å†™ Lua è„šæœ¬
   - åªéœ€ä¿®æ”¹ç°æœ‰ä»£ç 

2. **æ€§èƒ½æå‡æ˜æ˜¾**
   - æ­¥é•¿ 1ï¼š11.7 å€æ€§èƒ½æå‡
   - æ­¥é•¿ 20ï¼š3.7 å€æ€§èƒ½æå‡
   - æ­¥é•¿ 60ï¼š1.5 å€æ€§èƒ½æå‡

3. **çµæ´»æ€§é«˜**
   - å¯ä»¥æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å®‰å…¨ç³»æ•°
   - å¯ä»¥åŠ¨æ€è°ƒæ•´ä¸Šé™
   - æ˜“äºè°ƒè¯•å’Œç›‘æ§

4. **é£é™©ä½**
   - ä¸æ”¹å˜ç°æœ‰æ¶æ„
   - å‘åå…¼å®¹
   - æ˜“äºå›æ»š

#### ä¸æ¨è Lua è„šæœ¬çš„åŸå› 

1. **å¤æ‚åº¦é«˜**
   - éœ€è¦ç¼–å†™å’Œç»´æŠ¤ Lua è„šæœ¬
   - è°ƒè¯•å›°éš¾
   - å›¢é˜Ÿéœ€è¦å­¦ä¹  Lua

2. **çµæ´»æ€§å·®**
   - ä¿®æ”¹é€»è¾‘éœ€è¦é‡æ–°éƒ¨ç½²è„šæœ¬
   - éš¾ä»¥åŠ¨æ€è°ƒæ•´å‚æ•°

3. **æ€§èƒ½æå‡æœ‰é™**
   - ç›¸æ¯”æ–¹æ¡ˆ B2ï¼Œæ€§èƒ½æå‡ä¸æ˜æ˜¾
   - å¢åŠ äº† Redis æœåŠ¡å™¨çš„ CPU è´Ÿæ‹…

---

## ğŸš€ å®æ–½æ–¹æ¡ˆ B2

### å®Œæ•´ä»£ç å®ç°

```typescript
// backend/src/api.ts

app.get('/api/blocks', async (req, res) => {
  try {
    const limit = parseInt(req.query.limit as string) || 264;
    const ruleValue = parseInt(req.query.ruleValue as string) || 1;
    const startBlock = parseInt(req.query.startBlock as string) || 0;
    
    // âœ… åŠ¨æ€è®¡ç®—éœ€è¦åŠ è½½çš„åŸå§‹æ•°æ®é‡
    // å…¬å¼ï¼šéœ€è¦çš„è¿‡æ»¤åæ•°æ®é‡ Ã— æ­¥é•¿ Ã— å®‰å…¨ç³»æ•°
    const safetyFactor = 1.5;  // å®‰å…¨ç³»æ•°
    const estimatedRawBlocks = Math.ceil(limit * ruleValue * safetyFactor);
    const MAX_RAW_BLOCKS = Math.min(estimatedRawBlocks, 30000);  // ä¸Šé™ä¿æŠ¤
    
    console.log(`[API] ğŸ“¥ è§„åˆ™è¿‡æ»¤è¯·æ±‚: æ­¥é•¿ ${ruleValue}, åç§» ${startBlock}, éœ€è¦ ${limit} æ¡è¿‡æ»¤åæ•°æ®`);
    console.log(`[API] ğŸ“Š é¢„ä¼°éœ€è¦åŠ è½½: ${estimatedRawBlocks} æ¡åŸå§‹æ•°æ®ï¼Œå®é™…åŠ è½½: ${MAX_RAW_BLOCKS} æ¡`);
    
    // âœ… æ€§èƒ½ç›‘æ§ï¼šå¼€å§‹è®¡æ—¶
    const startTime = Date.now();
    
    // 1. ä» Redis åŠ è½½åŠ¨æ€è®¡ç®—çš„æ•°æ®é‡
    const allBlocks = await getBlocks(MAX_RAW_BLOCKS);
    const loadTime = Date.now();
    console.log(`[API] ğŸ“¦ åŠ è½½åŸå§‹æ•°æ®: ${allBlocks.length} æ¡ï¼Œè€—æ—¶: ${loadTime - startTime}ms`);
    
    // 2. æ ¹æ®è§„åˆ™è¿‡æ»¤æ•°æ®
    let filteredBlocks = allBlocks;
    if (ruleValue > 1) {
      filteredBlocks = allBlocks.filter(block => {
        if (startBlock > 0) {
          return block.height >= startBlock && (block.height - startBlock) % ruleValue === 0;
        }
        return block.height % ruleValue === 0;
      });
    }
    const filterTime = Date.now();
    console.log(`[API] ğŸ” è¿‡æ»¤åæ•°æ®: ${filteredBlocks.length} æ¡ (æ­¥é•¿ ${ruleValue})ï¼Œè€—æ—¶: ${filterTime - loadTime}ms`);
    
    // 3. è¿”å›æœ€æ–°çš„ N æ¡æ•°æ®
    const resultBlocks = filteredBlocks.slice(0, limit);
    const endTime = Date.now();
    console.log(`[API] âœ… è¿”å›æ•°æ®: ${resultBlocks.length} æ¡ (è¯·æ±‚: ${limit} æ¡)ï¼Œæ€»è€—æ—¶: ${endTime - startTime}ms`);
    
    // 4. è®¡ç®—ç»Ÿè®¡ä¿¡æ¯
    const dataReduction = ((1 - MAX_RAW_BLOCKS / 30000) * 100).toFixed(1);
    console.log(`[API] ğŸ’¾ æ•°æ®åŠ è½½ä¼˜åŒ–: å‡å°‘ ${dataReduction}% çš„æ•°æ®åŠ è½½ (${MAX_RAW_BLOCKS} / 30,000)`);
    
    res.json({
      success: true,
      data: resultBlocks,
      count: resultBlocks.length,
      metadata: {
        ruleValue,
        startBlock,
        totalRaw: allBlocks.length,
        totalFiltered: filteredBlocks.length,
        returned: resultBlocks.length,
        requested: limit,
        estimatedRawBlocks,
        actualRawBlocks: MAX_RAW_BLOCKS,
        dataReduction: `${dataReduction}%`,
        performance: {
          redisLoad: loadTime - startTime,
          memoryFilter: filterTime - loadTime,
          total: endTime - startTime,
        }
      }
    });
  } catch (error: any) {
    console.error('[API] âŒ é”™è¯¯:', error.message);
    res.status(500).json({
      success: false,
      error: error.message,
    });
  }
});
```

### æµ‹è¯•éªŒè¯

#### æµ‹è¯•ç”¨ä¾‹ 1ï¼šæ­¥é•¿ 1ï¼ˆ3ç§’è§„åˆ™ï¼‰

**è¯·æ±‚**ï¼š
```
GET /api/blocks?limit=264&ruleValue=1&startBlock=0
```

**é¢„æœŸç»“æœ**ï¼š
```
[API] ğŸ“Š é¢„ä¼°éœ€è¦åŠ è½½: 396 æ¡åŸå§‹æ•°æ®ï¼Œå®é™…åŠ è½½: 396 æ¡
[API] ğŸ“¦ åŠ è½½åŸå§‹æ•°æ®: 396 æ¡ï¼Œè€—æ—¶: ~20ms
[API] ğŸ” è¿‡æ»¤åæ•°æ®: 396 æ¡ï¼Œè€—æ—¶: ~5ms
[API] âœ… è¿”å›æ•°æ®: 264 æ¡ï¼Œæ€»è€—æ—¶: ~35ms
[API] ğŸ’¾ æ•°æ®åŠ è½½ä¼˜åŒ–: å‡å°‘ 98.7% çš„æ•°æ®åŠ è½½
```

#### æµ‹è¯•ç”¨ä¾‹ 2ï¼šæ­¥é•¿ 20ï¼ˆ1åˆ†é’Ÿè§„åˆ™ï¼‰

**è¯·æ±‚**ï¼š
```
GET /api/blocks?limit=264&ruleValue=20&startBlock=0
```

**é¢„æœŸç»“æœ**ï¼š
```
[API] ğŸ“Š é¢„ä¼°éœ€è¦åŠ è½½: 7,920 æ¡åŸå§‹æ•°æ®ï¼Œå®é™…åŠ è½½: 7,920 æ¡
[API] ğŸ“¦ åŠ è½½åŸå§‹æ•°æ®: 7,920 æ¡ï¼Œè€—æ—¶: ~80ms
[API] ğŸ” è¿‡æ»¤åæ•°æ®: 396 æ¡ï¼Œè€—æ—¶: ~20ms
[API] âœ… è¿”å›æ•°æ®: 264 æ¡ï¼Œæ€»è€—æ—¶: ~110ms
[API] ğŸ’¾ æ•°æ®åŠ è½½ä¼˜åŒ–: å‡å°‘ 73.6% çš„æ•°æ®åŠ è½½
```

#### æµ‹è¯•ç”¨ä¾‹ 3ï¼šæ­¥é•¿ 100ï¼ˆ5åˆ†é’Ÿè§„åˆ™ï¼‰

**è¯·æ±‚**ï¼š
```
GET /api/blocks?limit=264&ruleValue=100&startBlock=0
```

**é¢„æœŸç»“æœ**ï¼š
```
[API] ğŸ“Š é¢„ä¼°éœ€è¦åŠ è½½: 39,600 æ¡åŸå§‹æ•°æ®ï¼Œå®é™…åŠ è½½: 30,000 æ¡ï¼ˆä¸Šé™ï¼‰
[API] ğŸ“¦ åŠ è½½åŸå§‹æ•°æ®: 30,000 æ¡ï¼Œè€—æ—¶: ~300ms
[API] ğŸ” è¿‡æ»¤åæ•°æ®: 300 æ¡ï¼Œè€—æ—¶: ~100ms
[API] âœ… è¿”å›æ•°æ®: 264 æ¡ï¼Œæ€»è€—æ—¶: ~410ms
[API] ğŸ’¾ æ•°æ®åŠ è½½ä¼˜åŒ–: å‡å°‘ 0% çš„æ•°æ®åŠ è½½
```

---

## ğŸ“ æ€»ç»“

### æ–¹æ¡ˆå¯¹æ¯”æ€»ç»“

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | æ€§èƒ½æå‡ | çµæ´»æ€§ | æ¨èåº¦ |
|------|---------|---------|--------|--------|
| æ–¹æ¡ˆ Aï¼šå†…å­˜è¿‡æ»¤ | ç®€å• | æ—  | é«˜ | â­ |
| æ–¹æ¡ˆ B1ï¼šLua è„šæœ¬ | å›°éš¾ | 2.5 å€ | ä½ | â­â­ |
| æ–¹æ¡ˆ B2ï¼šåŠ¨æ€è®¡ç®— | ç®€å• | 3-12 å€ | é«˜ | â­â­â­â­â­ |

### æœ€ç»ˆæ¨è

**é‡‡ç”¨æ–¹æ¡ˆ B2ï¼šåŠ¨æ€è®¡ç®— + å†…å­˜è¿‡æ»¤**

**ç†ç”±**ï¼š
1. âœ… å®æ–½ç®€å•ï¼Œåªéœ€ä¿®æ”¹ä¸€ä¸ªå‡½æ•°
2. âœ… æ€§èƒ½æå‡æ˜æ˜¾ï¼ˆ3-12 å€ï¼‰
3. âœ… çµæ´»æ€§é«˜ï¼Œæ˜“äºè°ƒæ•´
4. âœ… é£é™©ä½ï¼Œæ˜“äºå›æ»š
5. âœ… ç‰¹åˆ«é€‚åˆå°æ­¥é•¿è§„åˆ™ï¼ˆæ­¥é•¿ 1-20ï¼‰

**é¢„æœŸæ•ˆæœ**ï¼š
- æ­¥é•¿ 1ï¼š11.7 å€æ€§èƒ½æå‡ï¼ˆ410ms â†’ 35msï¼‰
- æ­¥é•¿ 20ï¼š3.7 å€æ€§èƒ½æå‡ï¼ˆ410ms â†’ 110msï¼‰
- æ­¥é•¿ 60ï¼š1.5 å€æ€§èƒ½æå‡ï¼ˆ410ms â†’ 270msï¼‰
- æ­¥é•¿ 100ï¼šæ— æ˜æ˜¾æå‡ï¼ˆæ¥è¿‘ä¸Šé™ï¼‰

---

**æ–‡æ¡£åˆ›å»ºæ—¶é—´**ï¼š2026-02-07  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0
